<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Life OS</title>
  <meta name="description" content="Student Life OS — assignments, networking, job apps, meetings, social + week calendar + reminders + Google Calendar (optional)." />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg:#f6f8ff;
      --panel:#ffffff;
      --panel2:#fbfcff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --border2:#dbeafe;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --brand:#4f46e5;
      --brand2:#7c3aed;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#eef2ff;
      --chipText:#3730a3;
      --focus:0 0 0 4px rgba(79,70,229,.18);
      --radius:16px;
      --radiusSm:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1000px 500px at 15% -10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(79,70,229,.16), transparent 62%),
        var(--bg);
    }
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:26px auto;padding:0 18px 30px}
    .top{
      display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:16px 16px 12px;border:1px solid var(--border);border-radius:var(--radius);
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow:var(--shadow);
    }
    .brand{display:flex;flex-direction:column;gap:4px}
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{font-size:12.5px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button, .btn{
      appearance:none;border:1px solid var(--border);background:var(--panel);
      padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:13px;
      color:var(--text); box-shadow:0 2px 0 rgba(2,6,23,.04);
    }
    button:hover{border-color:#cbd5e1}
    button:focus{outline:none;box-shadow:var(--focus)}
    .primary{
      background:linear-gradient(180deg, rgba(79,70,229,.12), rgba(79,70,229,.06));
      border-color:rgba(79,70,229,.35);
      color:#1e1b4b;
    }
    .danger{
      background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.06));
      border-color:rgba(239,68,68,.35);
      color:#7f1d1d;
    }
    .pill{
      display:inline-flex;gap:6px;align-items:center;
      padding:4px 10px;border-radius:999px;background:var(--chip);color:var(--chipText);
      border:1px solid rgba(79,70,229,.18);font-size:12px;font-weight:700;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid var(--border);border-radius:var(--radius);
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      border-bottom:1px solid var(--border);
    }
    .panelHead h2{margin:0;font-size:14px}
    .panelBody{padding:14px}
    .kpis{
      display:grid;grid-template-columns: repeat(5, 1fr);gap:10px;margin-top:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2,1fr)} }
    .kpi{
      border:1px solid var(--border);border-radius:14px;background:#fff;padding:12px 12px 10px;
    }
    .kpi .label{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
    .kpi .val{font-size:22px;font-weight:900;margin-top:6px}
    .filters{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center
    }
    input[type="text"], textarea, select, input[type="date"], input[type="time"], input[type="number"]{
      width:100%;
      padding:10px 11px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      font-size:13px;
      color:var(--text);
    }
    input:focus, textarea:focus, select:focus{outline:none;box-shadow:var(--focus);border-color:rgba(79,70,229,.35)}
    textarea{min-height:84px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1.1fr 1fr 1fr;gap:10px}
    @media (max-width: 560px){ .row,.row3{grid-template-columns:1fr} }
    .labelSm{font-size:12px;color:var(--muted);margin:0 0 6px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:7px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:800;font-size:12px;color:#1f2937;
    }
    .tab.active{
      border-color:rgba(79,70,229,.35);
      background:linear-gradient(180deg, rgba(79,70,229,.12), rgba(79,70,229,.05));
      color:#1e1b4b;
    }
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .item .left{min-width:0;flex:1}
    .title{font-weight:900;margin:0 0 6px;font-size:14px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .chip{
      display:inline-flex;gap:6px;align-items:center;
      font-size:12px;font-weight:800;
      padding:4px 9px;border-radius:999px;border:1px solid var(--border2);
      background:#f8fafc;color:#334155;
      max-width:100%;
    }
    .chip.bad{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.08);color:#7f1d1d}
    .chip.warn{border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.10);color:#7c2d12}
    .chip.ok{border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.10);color:#14532d}
    .note{color:#475569;font-size:12.5px;line-height:1.35;white-space:pre-wrap}
    .btns{display:flex;flex-direction:column;gap:8px}
    .iconBtn{
      width:38px;height:38px;border-radius:12px;display:grid;place-items:center;
      border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:900;
    }
    .iconBtn.done{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.08);color:#14532d}
    .iconBtn.del{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#7f1d1d}
    .muted{color:var(--muted);font-size:12px}
    .sep{height:1px;background:var(--border);margin:10px 0}
    .weekWrap{
      padding:12px;border:1px solid var(--border);border-radius:14px;background:#fff;
    }
    .weekHead{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px
    }
    .weekHead .range{font-weight:900}
    .weekGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .day{
      border:1px solid var(--border);
      border-radius:14px;
      background:linear-gradient(180deg, #ffffff, #fbfcff);
      min-height:160px;
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .day .dtop{display:flex;justify-content:space-between;align-items:baseline}
    .dow{font-size:12px;color:var(--muted);font-weight:900}
    .dnum{font-size:12px;color:#1f2937;font-weight:900}
    .blocks{display:flex;flex-direction:column;gap:6px}
    .block{
      border:1px solid rgba(79,70,229,.18);
      background:rgba(79,70,229,.07);
      border-left:4px solid rgba(79,70,229,.55);
      border-radius:12px;
      padding:8px 8px;
      font-size:12px;
      overflow:hidden;
    }
    .block.gcal{
      border:1px solid rgba(100,116,139,.22);
      background:rgba(100,116,139,.07);
      border-left:4px solid rgba(100,116,139,.55);
    }
    .block .btitle{font-weight:900;line-height:1.15;margin-bottom:4px}
    .block .btime{color:#334155;font-weight:800}
    .block .bsub{color:#64748b;font-weight:800}
    .tiny{font-size:11px;color:var(--muted)}
    .footerNote{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.4}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .toast{
      position:fixed;bottom:18px;left:50%;transform:translateX(-50%);
      background:#0b1220;color:#e2e8f0;border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;border-radius:999px;box-shadow:0 16px 40px rgba(2,6,23,.25);
      display:none;gap:8px;align-items:center;font-size:13px;font-weight:800;
      z-index:9999;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Student Life OS</h1>
        <div class="sub">
          Assignments • Networking • Job apps • Meetings • Social • Week calendar • Recurring tasks • Reminders
          <span class="pill" id="storagePill">stored locally</span>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="remindersBtn">Enable reminders</button>
        <button class="primary" id="gcalBtn">Connect Google Calendar</button>
        <button id="refreshGcalBtn" style="display:none">Refresh Google Calendar</button>
        <button id="exportBtn">Export</button>
        <button id="importBtn">Import</button>
        <button class="danger" id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="filters">
      <div style="flex:1; min-width:240px">
        <input id="search" type="text" placeholder="Search everything (title, notes, company, people…)" />
      </div>
      <div style="min-width:180px">
        <select id="catFilter"></select>
      </div>
      <div style="min-width:160px">
        <select id="statusFilter"></select>
      </div>
      <div style="min-width:170px">
        <select id="sortBy">
          <option value="dueSoon">Sort: due soon</option>
          <option value="createdNew">Sort: newest</option>
          <option value="priorityHigh">Sort: priority</option>
          <option value="alpha">Sort: A→Z</option>
        </select>
      </div>
      <div style="min-width:140px">
        <select id="viewMode">
          <option value="list">View: list</option>
          <option value="week">View: week</option>
          <option value="both">View: both</option>
        </select>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="label"><span>Open items</span><span class="muted">not done</span></div>
        <div class="val" id="kOpen">0</div>
      </div>
      <div class="kpi">
        <div class="label"><span>Due in 48h</span><span class="muted">urgent</span></div>
        <div class="val" id="kSoon">0</div>
      </div>
      <div class="kpi">
        <div class="label"><span>Overdue</span><span class="muted">past due</span></div>
        <div class="val" id="kOver">0</div>
      </div>
      <div class="kpi">
        <div class="label"><span>Networking to do</span><span class="muted">open</span></div>
        <div class="val" id="kNet">0</div>
      </div>
      <div class="kpi">
        <div class="label"><span>This week</span><span class="muted">occurrences</span></div>
        <div class="val" id="kWeek">0</div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="panelHead">
          <h2>Add / edit item</h2>
          <div class="muted">Recurring tasks generate occurrences in week view. Reminders fire while this page is open.</div>
        </div>
        <div class="panelBody">
          <div class="row3">
            <div>
              <div class="labelSm">Category</div>
              <select id="type">
                <option value="assignment">Assignment</option>
                <option value="class">Class</option>
                <option value="networking">Networking</option>
                <option value="job">Job app</option>
                <option value="meeting">Meeting</option>
                <option value="social">Social</option>
                <option value="personal">Personal</option>
              </select>
            </div>
            <div>
              <div class="labelSm">Status</div>
              <select id="status">
                <option value="todo">To do</option>
                <option value="in_progress">In progress</option>
                <option value="waiting">Waiting</option>
                <option value="done">Done</option>
              </select>
            </div>
            <div>
              <div class="labelSm">Priority</div>
              <select id="priority">
                <option value="1">Low</option>
                <option value="2" selected>Medium</option>
                <option value="3">High</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <div class="labelSm">Title</div>
            <input id="title" type="text" placeholder="e.g., Econ pset #3 / Coffee chat / Apply to internship" />
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <div class="labelSm">Date (optional)</div>
              <input id="date" type="date" />
            </div>
            <div>
              <div class="labelSm">Time (optional)</div>
              <input id="time" type="time" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <div class="labelSm">People / Company (optional)</div>
              <input id="who" type="text" placeholder="e.g., Maya (Goldman) / Professor Kim" />
            </div>
            <div>
              <div class="labelSm">Reminder</div>
              <select id="reminder">
                <option value="0">No reminder</option>
                <option value="5">5 min before</option>
                <option value="10">10 min before</option>
                <option value="30">30 min before</option>
                <option value="60">60 min before</option>
                <option value="180">3 hours before</option>
                <option value="1440">1 day before</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <div class="labelSm">Recurring</div>
              <select id="recurring">
                <option value="none" selected>None</option>
                <option value="daily">Daily</option>
                <option value="weekdays">Weekdays (Mon–Fri)</option>
                <option value="weekly">Weekly</option>
                <option value="biweekly">Every 2 weeks</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div>
              <div class="labelSm">Recurring ends</div>
              <input id="recurringUntil" type="date" />
            </div>
          </div>

          <div style="margin-top:10px">
            <div class="labelSm">Notes</div>
            <textarea id="notes" placeholder="Links, next steps, what to say, meeting agenda, etc."></textarea>
          </div>

          <div class="sep"></div>

          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div class="muted">Tip: put links in Notes. Search finds them later.</div>
            <div style="display:flex;gap:10px;align-items:center">
              <button id="clearFormBtn">Clear</button>
              <button class="primary" id="saveBtn">Add</button>
            </div>
          </div>

          <div class="footerNote">
            <strong>Sharing:</strong> This site stores data <strong>only in each person’s browser</strong> (localStorage). If someone opens your link, they get their own empty copy unless they import/export.
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <h2 style="margin:0">Your items</h2>
            <div class="muted">Click an item to edit. ✓ toggles done.</div>
          </div>
          <div class="tabs" id="tabs"></div>
        </div>
        <div class="panelBody">
          <button id="settingsToggle" class="btn" style="margin-bottom:10px">Settings</button>

          <div id="settingsBox" style="display:none">
            <div style="padding:12px;border:1px solid var(--border);border-radius:14px;background:#fff">
              <div style="font-weight:900;margin-bottom:6px">Google Calendar (optional)</div>
              <div class="muted" style="margin-bottom:8px">
                Paste your Google OAuth Client ID (Web). Works on GitHub Pages/Vercel. For Google Cloud:
                <span class="mono">Authorized JS origin</span> = <span class="mono">https://noahsisskind.github.io</span> (your username may differ).
                Add yourself as a <span class="mono">Test user</span> in Google Auth Platform → Audience.
              </div>

              <div class="row" style="align-items:end">
                <div>
                  <div class="labelSm">OAuth Client ID</div>
                  <input id="clientId" class="mono" type="text" placeholder="xxxxx.apps.googleusercontent.com" />
                  <div class="tiny" id="originLine"></div>
                </div>
                <div style="display:flex;gap:10px">
                  <button id="saveClientIdBtn" class="primary">Save</button>
                  <button id="disconnectBtn">Disconnect</button>
                </div>
              </div>

              <div id="gcalPicker" style="display:none;margin-top:10px"></div>
            </div>
            <div class="sep"></div>
          </div>

          <div id="weekPanel" style="display:none">
            <div class="weekWrap">
              <div class="weekHead">
                <div>
                  <div class="range" id="weekRange">Week</div>
                  <div class="tiny" id="weekCounts"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <button id="prevWeekBtn">←</button>
                  <button id="todayBtn">Today</button>
                  <button id="nextWeekBtn">→</button>
                </div>
              </div>
              <div class="weekGrid" id="weekGrid"></div>
            </div>
            <div class="sep"></div>
          </div>

          <div class="list" id="list"></div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(() => {
  // =========================
  // Storage + state
  // =========================
  const STORAGE_KEY = "studentLifeOS:v2";
  const CLIENT_KEY  = "studentLifeOS:gcal:clientId";
  const GCAL_SEL_KEY = "studentLifeOS:gcal:selectedCalendars";

  const now = () => Date.now();
  const uid = () => Math.random().toString(36).slice(2) + "-" + Math.random().toString(36).slice(2);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const pad2 = n => String(n).padStart(2,"0");

  const TYPES = [
    { id:"all", label:"All" },
    { id:"assignment", label:"Assignments" },
    { id:"class", label:"Classes" },
    { id:"networking", label:"Networking" },
    { id:"job", label:"Job Apps" },
    { id:"meeting", label:"Meetings" },
    { id:"social", label:"Social" },
    { id:"personal", label:"Personal" }
  ];

  const STATUSES = [
    { id:"all", label:"All statuses" },
    { id:"todo", label:"To do" },
    { id:"in_progress", label:"In progress" },
    { id:"waiting", label:"Waiting" },
    { id:"done", label:"Done" }
  ];

  const PRIORITY_LABEL = { "1":"Low", "2":"Medium", "3":"High" };

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { items:[], activeTab:"all", viewMode:"list", gcal:{ connected:false } };
      const s = JSON.parse(raw);
      if(!s.items) s.items = [];
      if(!s.activeTab) s.activeTab = "all";
      if(!s.viewMode) s.viewMode = "list";
      if(!s.gcal) s.gcal = { connected:false };
      return s;
    }catch{
      return { items:[], activeTab:"all", viewMode:"list", gcal:{ connected:false } };
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();
  let editingId = null;

  // =========================
  // DOM
  // =========================
  const $ = sel => document.querySelector(sel);
  const el = {
    storagePill: $("#storagePill"),
    search: $("#search"),
    catFilter: $("#catFilter"),
    statusFilter: $("#statusFilter"),
    sortBy: $("#sortBy"),
    viewMode: $("#viewMode"),
    tabs: $("#tabs"),
    list: $("#list"),
    weekPanel: $("#weekPanel"),
    weekGrid: $("#weekGrid"),
    weekRange: $("#weekRange"),
    weekCounts: $("#weekCounts"),

    type: $("#type"),
    status: $("#status"),
    title: $("#title"),
    date: $("#date"),
    time: $("#time"),
    who: $("#who"),
    priority: $("#priority"),
    notes: $("#notes"),
    reminder: $("#reminder"),
    recurring: $("#recurring"),
    recurringUntil: $("#recurringUntil"),

    clearFormBtn: $("#clearFormBtn"),
    saveBtn: $("#saveBtn"),

    exportBtn: $("#exportBtn"),
    importBtn: $("#importBtn"),
    resetBtn: $("#resetBtn"),

    kOpen: $("#kOpen"),
    kSoon: $("#kSoon"),
    kOver: $("#kOver"),
    kNet: $("#kNet"),
    kWeek: $("#kWeek"),

    remindersBtn: $("#remindersBtn"),
    settingsToggle: $("#settingsToggle"),
    settingsBox: $("#settingsBox"),

    clientId: $("#clientId"),
    saveClientIdBtn: $("#saveClientIdBtn"),
    originLine: $("#originLine"),
    disconnectBtn: $("#disconnectBtn"),

    gcalBtn: $("#gcalBtn"),
    refreshGcalBtn: $("#refreshGcalBtn"),
    gcalPicker: $("#gcalPicker"),

    prevWeekBtn: $("#prevWeekBtn"),
    nextWeekBtn: $("#nextWeekBtn"),
    todayBtn: $("#todayBtn"),

    toast: $("#toast"),
  };

  // =========================
  // Toast
  // =========================
  let toastTimer = null;
  function toast(msg){
    clearTimeout(toastTimer);
    el.toast.textContent = msg;
    el.toast.style.display = "inline-flex";
    toastTimer = setTimeout(()=> el.toast.style.display="none", 2000);
  }

  // =========================
  // Date helpers
  // =========================
  function toLocalDateStr(d){
    const yyyy = d.getFullYear();
    const mm = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    return `${yyyy}-${mm}-${dd}`;
  }

  function startOfDay(d){
    const x = new Date(d);
    x.setHours(0,0,0,0);
    return x;
  }

  function parseDue(item){
    if(!item.dueDate) return null;
    const d = new Date(item.dueDate + "T" + (item.dueTime || "00:00"));
    return isNaN(d.getTime()) ? null : d;
  }

  function startOfWeek(d){ // Monday
    const x = startOfDay(d);
    const day = x.getDay(); // 0 Sun
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate() + diff);
    return x;
  }

  function addDays(d, n){
    const x = new Date(d);
    x.setDate(x.getDate() + n);
    return x;
  }

  function formatNiceDateTime(d){
    const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const hh = d.getHours();
    const mm = pad2(d.getMinutes());
    const ap = hh >= 12 ? "PM" : "AM";
    const h12 = ((hh + 11) % 12) + 1;
    return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}, ${h12}:${mm} ${ap}`;
  }

  function formatTimeRange(start, end){
    // start/end can be dateTime strings or date strings
    const sAllDay = start && start.length === 10;
    const eAllDay = end && end.length === 10;
    if(sAllDay){
      return "All day";
    }
    try{
      const sd = new Date(start);
      const ed = new Date(end);
      const sh = ((sd.getHours()+11)%12)+1;
      const eh = ((ed.getHours()+11)%12)+1;
      const sm = pad2(sd.getMinutes());
      const em = pad2(ed.getMinutes());
      const sap = sd.getHours()>=12?"PM":"AM";
      const eap = ed.getHours()>=12?"PM":"AM";
      return `${sh}:${sm} ${sap}–${eh}:${em} ${eap}`;
    }catch{
      return "";
    }
  }

  // =========================
  // Recurring logic (simple)
  // =========================
  function occursOnDate(item, dateObj){
    // Returns true if item (possibly recurring) occurs on dateObj (local)
    const due = parseDue(item);
    if(!due) return false;

    const day = startOfDay(dateObj).getTime();
    const base = startOfDay(due).getTime();
    if(day < base) return false;

    // recurring end
    if(item.recurringUntil){
      const until = startOfDay(new Date(item.recurringUntil)).getTime();
      if(day > until) return false;
    }

    const rule = item.recurring || "none";
    if(rule === "none") return day === base;

    const diffDays = Math.floor((day - base) / 86400000);
    if(rule === "daily") return true;
    if(rule === "weekdays"){
      const dow = dateObj.getDay();
      return dow >= 1 && dow <= 5;
    }
    if(rule === "weekly") return diffDays % 7 === 0;
    if(rule === "biweekly") return diffDays % 14 === 0;
    if(rule === "monthly"){
      // same day-of-month
      const bd = new Date(base);
      return dateObj.getDate() === bd.getDate();
    }
    return false;
  }

  function occurrencesInWeek(weekStart){
    const days = [...Array(7)].map((_,i)=> addDays(weekStart,i));
    const occ = [];
    for(const item of state.items){
      if(item.status === "done") continue;
      const due = parseDue(item);
      if(!due) continue;
      for(const d of days){
        if(occursOnDate(item, d)){
          occ.push({ kind:"task", item, date: d });
        }
      }
    }
    return occ;
  }

  // =========================
  // Reminders (while page open)
  // =========================
  let remindersEnabled = false;
  let reminderTimers = [];
  function clearReminderTimers(){
    for(const t of reminderTimers) clearTimeout(t);
    reminderTimers = [];
  }

  function scheduleReminders(){
    clearReminderTimers();
    if(!remindersEnabled) return;
    const nowMs = Date.now();

    for(const item of state.items){
      if(item.status === "done") continue;
      const due = parseDue(item);
      if(!due) continue;

      const mins = Number(item.reminderMins || 0);
      if(!mins) continue;

      // For recurring: schedule for each occurrence in next 7 days
      const wk = startOfWeek(new Date());
      for(let i=0;i<7;i++){
        const d = addDays(wk,i);
        if(!occursOnDate(item, d)) continue;

        // compute occurrence datetime same time as due
        const occDT = new Date(d);
        occDT.setHours(due.getHours(), due.getMinutes(), 0, 0);

        const fireAt = occDT.getTime() - mins*60000;
        if(fireAt <= nowMs) continue;
        const delay = fireAt - nowMs;

        const label = `${itemTitle(item)} (${typeLabel(item.type)})`;
        const t = setTimeout(()=>{
          notify(`Reminder: ${label}`, { body: itemShort(item) });
        }, delay);

        reminderTimers.push(t);
      }
    }
  }

  async function enableReminders(){
    if(!("Notification" in window)){
      alert("This browser doesn't support notifications.");
      return;
    }
    const perm = await Notification.requestPermission();
    if(perm !== "granted"){
      alert("Notifications not enabled.");
      remindersEnabled = false;
      render();
      return;
    }
    remindersEnabled = true;
    toast("Reminders enabled");
    scheduleReminders();
    render();
  }

  function notify(title, opts){
    try{
      new Notification(title, opts);
    }catch{
      // fallback
      alert(title + (opts?.body ? "\n\n" + opts.body : ""));
    }
  }

  // =========================
  // Google Calendar (GIS token client)
  // =========================
  const GOOGLE_SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
  let tokenClient = null;
  let gcalAccessToken = null;
  let gcalCalendars = [];          // {id, summary, primary, backgroundColor}
  let gcalSelectedIds = new Set();
  let gcalEventsThisWeek = [];     // normalized events

  function originText(){
    return `Current origin: ${location.origin}`;
  }

  function loadClientId(){
    return localStorage.getItem(CLIENT_KEY) || "";
  }

  function saveClientId(val){
    localStorage.setItem(CLIENT_KEY, (val||"").trim());
  }

  function isConnected(){
    return !!gcalAccessToken;
  }

  function ensureTokenClient(){
    const cid = loadClientId();
    if(!cid){
      alert("Add your Google OAuth Client ID in Settings first.");
      return false;
    }
    if(!window.google || !google.accounts || !google.accounts.oauth2){
      alert("Google script not loaded yet. Refresh and try again.");
      return false;
    }
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: cid,
      scope: GOOGLE_SCOPES,
      prompt: "consent",
      callback: async (resp) => {
        if(resp.error){
          console.error(resp);
          alert("Google auth error: " + resp.error);
          return;
        }
        gcalAccessToken = resp.access_token;
        state.gcal = { connected:true, at: Date.now() };
        saveState();
        toast("Google Calendar connected");
        await listCalendarsAndRenderPicker();
        await refreshGoogleCalendarForCurrentWeek(true);
        render();
      }
    });
    return true;
  }

  function gcalHeaders(){
    return { Authorization: `Bearer ${gcalAccessToken}` };
  }

  async function gcalFetchJson(url){
    const res = await fetch(url, { headers: gcalHeaders() });
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }catch{ data = { raw:text }; }
    if(!res.ok){
      const msg = data?.error?.message || `Google API error ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  async function listCalendarsAndRenderPicker(){
    if(!isConnected()) return;
    const data = await gcalFetchJson("https://www.googleapis.com/calendar/v3/users/me/calendarList?minAccessRole=reader&showHidden=false");
    gcalCalendars = (data.items || []).map(c => ({
      id: c.id,
      summary: c.summary,
      primary: !!c.primary,
      backgroundColor: c.backgroundColor || "#64748b"
    }));

    // restore selection
    const saved = localStorage.getItem(GCAL_SEL_KEY);
    if(saved){
      try{
        const ids = JSON.parse(saved);
        gcalSelectedIds = new Set((ids||[]).filter(Boolean));
      }catch{}
    }
    // default: all calendars
    if(gcalSelectedIds.size === 0){
      gcalCalendars.forEach(c => gcalSelectedIds.add(c.id));
    }

    renderCalendarPicker();
  }

  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderCalendarPicker(statusText){
    const box = el.gcalPicker;
    if(!box) return;
    if(!isConnected()){
      box.style.display = "none";
      return;
    }
    box.style.display = "block";

    const rows = gcalCalendars
      .sort((a,b) => (b.primary - a.primary) || a.summary.localeCompare(b.summary))
      .map(c => {
        const checked = gcalSelectedIds.has(c.id) ? "checked" : "";
        const label = c.primary ? `${c.summary} (primary)` : c.summary;
        return `
          <label style="display:flex;gap:10px;align-items:center;padding:6px 0;">
            <input type="checkbox" data-calid="${esc(c.id)}" ${checked}/>
            <span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${c.backgroundColor};"></span>
            <span style="font-weight:800;color:#0f172a">${esc(label)}</span>
          </label>
        `;
      }).join("");

    box.innerHTML = `
      <div style="padding:12px;border:1px solid var(--border);border-radius:14px;background:#fff">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="font-weight:900">Calendars to include</div>
          <div style="display:flex;gap:8px">
            <button id="gAll" type="button">All</button>
            <button id="gNone" type="button">None</button>
            <button id="gApply" type="button" class="primary">Apply</button>
          </div>
        </div>
        <div style="margin-top:8px;max-height:220px;overflow:auto">
          ${rows || `<div class="muted">No calendars found.</div>`}
        </div>
        <div class="tiny" id="gcalStatus">${esc(statusText || "")}</div>
      </div>
    `;

    box.querySelectorAll('input[type="checkbox"][data-calid]').forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const id = cb.getAttribute("data-calid");
        if(cb.checked) gcalSelectedIds.add(id);
        else gcalSelectedIds.delete(id);
        localStorage.setItem(GCAL_SEL_KEY, JSON.stringify([...gcalSelectedIds]));
      });
    });

    box.querySelector("#gAll").onclick = ()=>{
      gcalCalendars.forEach(c=> gcalSelectedIds.add(c.id));
      localStorage.setItem(GCAL_SEL_KEY, JSON.stringify([...gcalSelectedIds]));
      renderCalendarPicker(statusText);
    };
    box.querySelector("#gNone").onclick = ()=>{
      gcalSelectedIds.clear();
      localStorage.setItem(GCAL_SEL_KEY, JSON.stringify([]));
      renderCalendarPicker(statusText);
    };
    box.querySelector("#gApply").onclick = async ()=>{
      await refreshGoogleCalendarForCurrentWeek(true);
      render();
    };
  }

  async function fetchEventsForWeek(weekStartISO, weekEndISO){
    const ids = [...gcalSelectedIds];
    if(ids.length === 0) return [];

    const results = await Promise.allSettled(ids.map(async (calId)=>{
      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events`);
      url.searchParams.set("timeMin", weekStartISO);
      url.searchParams.set("timeMax", weekEndISO);
      url.searchParams.set("singleEvents", "true");
      url.searchParams.set("orderBy", "startTime");
      url.searchParams.set("maxResults", "2500");
      const data = await gcalFetchJson(url.toString());
      const cal = gcalCalendars.find(c=>c.id===calId);
      return (data.items || [])
        .filter(e => e.status !== "cancelled")
        .map(e => ({
          source:"gcal",
          id:`gcal:${calId}:${e.id}`,
          calId,
          calName: cal?.summary || "Google Calendar",
          calColor: cal?.backgroundColor || "#64748b",
          title: e.summary || "(no title)",
          start: e.start?.dateTime || e.start?.date,
          end: e.end?.dateTime || e.end?.date,
          htmlLink: e.htmlLink || ""
        }));
    }));

    let ok=0, err=0;
    const all=[];
    for(const r of results){
      if(r.status==="fulfilled"){ ok++; all.push(...r.value); }
      else { err++; console.warn("GCAL fetch failed:", r.reason); }
    }
    const seen = new Set();
    const dedup = all.filter(e => seen.has(e.id) ? false : (seen.add(e.id), true));
    renderCalendarPicker(`Fetched ${dedup.length} events from ${ok} calendars${err?` (${err} failed)`:``}.`);
    return dedup;
  }

  async function refreshGoogleCalendarForCurrentWeek(silent=false){
    if(!isConnected()) return;
    const wk = startOfWeek(weekCursor);
    const wkEnd = addDays(wk, 7);

    // ISO for Calendar API (needs full date-time with timezone)
    const timeMin = new Date(wk); timeMin.setHours(0,0,0,0);
    const timeMax = new Date(wkEnd); timeMax.setHours(0,0,0,0);

    try{
      gcalEventsThisWeek = await fetchEventsForWeek(timeMin.toISOString(), timeMax.toISOString());
      if(!silent) toast("Calendar refreshed");
    }catch(err){
      console.error(err);
      alert("Google Calendar error: " + err.message);
    }
  }

  function disconnectGoogle(){
    gcalAccessToken = null;
    gcalCalendars = [];
    gcalSelectedIds = new Set();
    gcalEventsThisWeek = [];
    state.gcal = { connected:false };
    saveState();
    el.refreshGcalBtn.style.display = "none";
    el.gcalBtn.style.display = "inline-block";
    renderCalendarPicker("");
    render();
  }

  // =========================
  // UI Options
  // =========================
  function typeLabel(type){
    return (TYPES.find(t=>t.id===type)?.label) || type;
  }

  function itemTitle(item){
    return item.title?.trim() || "(untitled)";
  }

  function itemShort(item){
    const bits=[];
    if(item.who) bits.push(item.who);
    if(item.notes) bits.push(item.notes.slice(0,160));
    return bits.join(" • ");
  }

  // =========================
  // Rendering
  // =========================
  function buildSelect(selectEl, options, selected){
    selectEl.innerHTML = options.map(o => `<option value="${o.id}" ${o.id===selected?'selected':''}>${o.label}</option>`).join("");
  }

  function setForm(item){
    el.type.value = item?.type || "assignment";
    el.status.value = item?.status || "todo";
    el.title.value = item?.title || "";
    el.date.value = item?.dueDate || "";
    el.time.value = item?.dueTime || "";
    el.who.value = item?.who || "";
    el.priority.value = item?.priority || "2";
    el.notes.value = item?.notes || "";
    el.reminder.value = String(item?.reminderMins || 0);
    el.recurring.value = item?.recurring || "none";
    el.recurringUntil.value = item?.recurringUntil || "";
    el.saveBtn.textContent = editingId ? "Save" : "Add";
  }

  function clearForm(){
    editingId = null;
    setForm(null);
  }

  function matchesFilters(item){
    const q = el.search.value.trim().toLowerCase();
    const cat = el.catFilter.value;
    const st = el.statusFilter.value;
    const tab = state.activeTab || "all";

    if(tab !== "all" && item.type !== tab) return false;
    if(cat !== "all" && item.type !== cat) return false;
    if(st !== "all" && item.status !== st) return false;

    if(!q) return true;
    const hay = [
      item.title, item.notes, item.who, item.type, item.status
    ].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  }

  function sortItems(items){
    const mode = el.sortBy.value;
    const copy = items.slice();

    if(mode === "alpha"){
      copy.sort((a,b)=> itemTitle(a).localeCompare(itemTitle(b)));
      return copy;
    }
    if(mode === "createdNew"){
      copy.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      return copy;
    }
    if(mode === "priorityHigh"){
      copy.sort((a,b)=> (Number(b.priority||2) - Number(a.priority||2)) || ((parseDue(a)?.getTime()||1e18) - (parseDue(b)?.getTime()||1e18)));
      return copy;
    }
    // dueSoon default
    copy.sort((a,b)=> (parseDue(a)?.getTime()||1e18) - (parseDue(b)?.getTime()||1e18));
    return copy;
  }

  function renderTabs(){
    el.tabs.innerHTML = TYPES.map(t=>{
      const active = (state.activeTab||"all") === t.id ? "active" : "";
      return `<button class="tab ${active}" data-tab="${t.id}">${t.label}</button>`;
    }).join("");
    el.tabs.querySelectorAll("[data-tab]").forEach(btn=>{
      btn.onclick = ()=>{
        state.activeTab = btn.getAttribute("data-tab");
        saveState();
        render();
      };
    });
  }

  function renderKPIs(){
    const items = state.items;
    const open = items.filter(i=> i.status !== "done").length;

    const tNow = new Date();
    const soonMs = tNow.getTime() + 48*3600*1000;

    let dueSoon = 0, overdue = 0, net = 0;
    for(const i of items){
      if(i.status === "done") continue;
      if(i.type === "networking") net++;
      const d = parseDue(i);
      if(!d) continue;
      const ms = d.getTime();
      if(ms < tNow.get
